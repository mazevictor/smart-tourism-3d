<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§åå—å›½å®¶æ¤ç‰©å›­ - é«˜æ¸…åœ°å›¾ç‰ˆ</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; color: #333; }
        #canvas-container { width: 100vw; height: 100vh; display: block; background: #eef2f5; }

        /* --- UI é¢æ¿æ ·å¼ (ä¿æŒåŸæ ·) --- */
        #ui-panel {
            position: absolute; top: 0; left: 0; height: 100vh; width: 380px;
            background: rgba(255, 255, 255, 0.96);
            box-shadow: 4px 0 20px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; z-index: 10;
            border-right: 1px solid #ddd; backdrop-filter: blur(10px);
        }
        .panel-header { padding: 20px; background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; }
        .panel-header h2 { margin: 0; font-size: 20px; letter-spacing: 1px; }
        .panel-header p { margin: 5px 0 0; font-size: 12px; opacity: 0.9; }

        /* æ–‡ä»¶ä¸Šä¼ æŒ‰é’® */
        .upload-btn-wrapper { margin-top: 10px; text-align: center; }
        .btn-upload {
            border: 1px dashed rgba(255,255,255,0.6); color: white; background: rgba(255,255,255,0.1);
            padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: 0.2s; display: inline-block;
        }
        .btn-upload:hover { background: rgba(255,255,255,0.2); }
        #map-upload-input { display: none; }

        .section { padding: 12px 15px; border-bottom: 1px solid #eee; }
        .section-title { font-size: 12px; font-weight: bold; color: #555; margin-bottom: 8px; display: block; }

        /* å¤©æ°”æŒ‰é’® */
        .weather-btn-group { display: flex; gap: 5px; }
        .weather-btn {
            flex: 1; padding: 8px; border: 1px solid #ddd; background: #f8f9fa;
            border-radius: 6px; cursor: pointer; font-size: 12px; transition: 0.3s;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
        }
        .weather-btn:hover { background: #e9ecef; }
        .weather-btn.active { background: #eaf6ff; border-color: #3498db; color: #3498db; font-weight: bold; }
        .weather-btn.active-hot { background: #fff5e6; border-color: #e67e22; color: #e67e22; }
        .weather-btn.active-rain { background: #e6f0fa; border-color: #2980b9; color: #2980b9; }

        /* å¼€å…³ä¸æŒ‰é’® */
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .toggle-label { font-size: 13px; font-weight: bold; color: #16a085; display: flex; align-items: center; gap: 5px; }
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #16a085; }
        input:checked + .slider:before { transform: translateX(14px); }
        
        .fault-btn, .surge-btn { 
            width: 100%; padding: 8px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: 0.2s; border: none; font-weight: bold;
        }
        .fault-btn { background: #fff; border: 1px solid #e74c3c; color: #e74c3c; margin-top: 5px;}
        .fault-btn.active { background: #e74c3c; color: white; }
        .surge-btn { background: #e67e22; color: white; }
        .surge-btn.active { background: #d35400; animation: pulse 1s infinite; }

        /* åˆ—è¡¨åŒº */
        .list-header { padding: 10px 15px; font-size: 12px; font-weight: bold; color: #666; background: #f8f9fa; display: flex; justify-content: space-between; border-bottom: 1px solid #eee;}
        .spots-list { flex: 1; overflow-y: auto; padding: 10px; background: #fff; }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .spots-list::-webkit-scrollbar { width: 6px; }
        .spots-list::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

        .spot-item {
            display: flex; align-items: center; padding: 10px; margin-bottom: 8px;
            background: white; border-radius: 8px; border: 1px solid #eee; transition: 0.2s;
        }
        .spot-item:hover { border-color: #27ae60; transform: translateX(2px); }
        .spot-item.in-route { border-left: 4px solid #27ae60; background: #f0f8ff; }
        .spot-item.disabled { opacity: 0.5; filter: grayscale(100%); pointer-events: none; }
        .spot-item.congested { border-color: #e74c3c; background: #fff5f5; }

        .spot-checkbox { margin-right: 12px; transform: scale(1.2); accent-color: #27ae60; cursor: pointer; }
        .spot-content { flex: 1; cursor: pointer; }
        .spot-name { font-weight: bold; font-size: 14px; color: #2c3e50; }
        .spot-meta { font-size: 11px; color: #7f8c8d; margin-top: 4px; display: flex; gap: 4px; flex-wrap: wrap; }
        
        .badge { padding: 2px 5px; border-radius: 3px; font-size: 10px; color: white; font-weight: bold;}
        .badge-indoor { background: #8e44ad; }
        .badge-outdoor { background: #27ae60; }
        .badge-stairs { background: #7f8c8d; }
        .badge-elevator { background: #3498db; }
        .badge-queue { background: #e74c3c; }

        /* åº•éƒ¨æ“ä½œ */
        .action-area { padding: 15px; border-top: 1px solid #eee; background: white; }
        #btn-plan {
            width: 100%; padding: 12px; background: #27ae60; color: white;
            border: none; border-radius: 6px; font-size: 15px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3); transition: 0.3s;
        }
        #btn-plan:hover { background: #219150; transform: translateY(-1px); }
        
        .alert-box { margin-top: 10px; font-size: 12px; padding: 10px; border-radius: 6px; display: none; border-left: 4px solid; }
        .alert-info { background: #d1ecf1; border-color: #17a2b8; color: #0c5460; }

        /* --- è¯¦æƒ…å¼¹çª— (å¸¦å›¾ç‰‡) --- */
        #detail-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 360px; background: white; border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); z-index: 100;
            display: none; overflow: hidden; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { opacity: 0; transform: translate(-50%, -45%) scale(0.9); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
        
        .modal-header-img { width: 100%; height: 180px; object-fit: cover; background: #eee; display: block;}
        .modal-content { padding: 20px; }
        .close-modal { 
            position: absolute; top: 10px; right: 10px; width: 30px; height: 30px; 
            background: rgba(0,0,0,0.5); color: white; border-radius: 50%; 
            text-align: center; line-height: 30px; cursor: pointer; font-weight: bold;
            transition: 0.2s;
        }
        .close-modal:hover { background: rgba(0,0,0,0.8); }

        /* --- 3D æ ‡ç­¾ --- */
        .label {
            color: #333; padding: 2px 6px; background: rgba(255, 255, 255, 0.85);
            border-radius: 4px; font-size: 10px; pointer-events: none; text-align: center;
            border: 1px solid #999; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-family: sans-serif; white-space: nowrap;
        }
        .label b { display: block; font-size: 11px; margin-bottom: 0; }
        .service-label { background: #3498db; color: white; border: none; font-weight:bold;}
        .congested-label { background: #e74c3c !important; color: white !important; z-index: 99; border: 2px solid white; }
        
        /* å†³ç­–å¼¹çª— */
        #decision-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 400px; background: white; border-radius: 12px; z-index: 200;
            box-shadow: 0 25px 60px rgba(0,0,0,0.4); display: none;
            border-top: 5px solid #e67e22;
        }
        .decision-body { padding: 20px; display: flex; gap: 15px; }
        .choice-card {
            flex: 1; padding: 15px; border: 1px solid #ddd; border-radius: 8px;
            cursor: pointer; text-align: center; transition: 0.2s;
        }
        .choice-card:hover { background: #f9f9f9; border-color: #bbb; }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <!-- UI é¢æ¿ -->
    <div id="ui-panel">
        <div class="panel-header">
            <h2>ğŸŒ¿ æ™ºæ…§åå—å›½å®¶æ¤ç‰©å›­</h2>
            <p>å…¨æ™¯å¯¼è§ˆ | æ™ºèƒ½é¿å µ | 30+ä¸“ç±»å›­</p>
            
            <!-- æ–‡ä»¶ä¸Šä¼ æŒ‰é’® -->
            <div class="upload-btn-wrapper">
                <label for="map-upload-input" class="btn-upload">ğŸ“‚ æ›´æ¢åœ°å›¾å›¾ç‰‡</label>
                <input type="file" id="map-upload-input" accept="image/*">
            </div>
        </div>

        <!-- å¤©æ°” -->
        <div class="section">
            <span class="section-title">ğŸŒ¤ï¸ å®æ—¶æ°”è±¡ (å¹¿å·å¤©æ²³åŒº)</span>
            <div class="weather-btn-group">
                <div class="weather-btn active" onclick="setWeather('clear', this)"><span>â˜€ï¸</span> æ™´æœ—</div>
                <div class="weather-btn" onclick="setWeather('hot', this)"><span>ğŸ”¥</span> é…·æš‘</div>
                <div class="weather-btn" onclick="setWeather('rain', this)"><span>ğŸŒ§ï¸</span> æš´é›¨</div>
            </div>
        </div>

        <!-- æ— éšœç¢ -->
        <div class="section" style="background: #f0fdf4;">
            <div class="toggle-row">
                <div class="toggle-label">â™¿ æ— éšœç¢/äº²å­æ¨¡å¼</div>
                <label class="switch">
                    <input type="checkbox" id="access-mode-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            <button class="fault-btn" id="btn-fault" onclick="toggleElevatorFault()">âš ï¸ æ¨¡æ‹Ÿæ¸©å®¤ç”µæ¢¯æ•…éšœ</button>
        </div>

        <!-- å®¢æµ -->
        <div class="section" style="background: #fff8f0;">
            <span class="section-title">ğŸ‘¥ å›­åŠ¡ç®¡ç†ä¸åº”æ€¥</span>
            <button class="surge-btn" id="btn-surge" onclick="toggleSurge()">ğŸ”¥ æ¨¡æ‹ŸèŠ‚å‡æ—¥å®¢æµæ¿€å¢</button>
            <div style="margin-top:8px; font-size:11px; color:#666;">
                å½“å‰å›­åŒºçŠ¶æ€: <span id="congestion-val" style="font-weight:bold; color:#27ae60">èˆ’é€‚</span>
            </div>
        </div>

        <!-- åˆ—è¡¨ -->
        <div class="list-header">
            <span>æ¸¸è§ˆæ™¯ç‚¹é€‰æ‹© (å…±32ä¸ª)</span>
            <span style="cursor:pointer; color:#3498db;" onclick="clearSelection()">æ¸…ç©º</span>
        </div>
        <div class="spots-list" id="spots-container">
            <!-- JSç”Ÿæˆ -->
        </div>

        <div class="action-area">
            <button id="btn-plan">ğŸš€ æ™ºèƒ½è§„åˆ’æ¸¸å›­è·¯çº¿</button>
            <div class="alert-box alert-info" id="alert-info"></div>
        </div>
    </div>

    <!-- è¯¦æƒ…å¼¹çª— -->
    <div id="detail-modal">
        <div class="close-modal" onclick="closeModal()">Ã—</div>
        <img src="" class="modal-header-img" id="modal-img" alt="æ™¯ç‚¹å®æ™¯">
        <div class="modal-content">
            <h3 style="margin:0 0 10px 0; color:#2c3e50;" id="modal-title">æ™¯ç‚¹åç§°</h3>
            <div id="modal-tags" style="margin-bottom:10px;"></div>
            <p style="font-size:13px; color:#555; line-height:1.6;" id="modal-desc">ä»‹ç»å†…å®¹...</p>
        </div>
    </div>

    <!-- å†³ç­–å¼¹çª— -->
    <div id="decision-modal">
        <div style="padding:15px; text-align:center; border-bottom:1px solid #eee;">
            <h3 style="margin:0; color:#d35400;">âš ï¸ æ‹¥å µé¢„è­¦</h3>
            <p style="margin:5px 0 0; font-size:13px;"><span id="warn-spot-name"></span> æ¸¸å®¢é‡è¿‡å¤§</p>
        </div>
        <div class="decision-body">
            <div class="choice-card" onclick="userDecision('wait')" style="background:#fff8f0; border-color:#e67e22;">
                <div style="font-weight:bold;">æ–¹æ¡ˆ A</div>
                <div style="font-size:20px; margin:5px 0;">æ’é˜Ÿ</div>
                <div style="font-size:11px; color:#666;">é¢„è®¡ç­‰å¾… 45åˆ†é’Ÿ</div>
            </div>
            <div class="choice-card" onclick="userDecision('reroute')" style="background:#f0fdf4; border-color:#27ae60;">
                <div style="font-weight:bold;">æ–¹æ¡ˆ B</div>
                <div style="font-size:20px; margin:5px 0; color:#27ae60;">æ¨è</div>
                <div style="font-size:11px; color:#666;">å‰å¾€ <span id="alt-spot-name"></span></div>
            </div>
        </div>
    </div>

    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

        // --- é…ç½®ä¸å¸¸é‡ ---
        // æ ¹æ®å›¾ç‰‡æ¯”ä¾‹ (2339x1654) è°ƒæ•´å¹³é¢å°ºå¯¸ï¼Œä¿æŒçº¦ 1.41:1 çš„æ¯”ä¾‹
        const MAP_WIDTH = 300;
        const MAP_HEIGHT = 212; 
        
        // åæ ‡ç³»æ ¡å‡†ï¼š
        // ä¸­å¿ƒ (0,0) å¤§çº¦åœ¨ "ç§‘å­¦å®¶ä¹‹å®¶" é™„è¿‘
        // æ­£é—¨ (Bottom Left) çº¦ (-50, 90)
        // è¥¿é—¨ (Bottom Right) çº¦ (120, 70)
        // æœ¨å…°å›­ (Top Center) çº¦ (-20, -90)

        const START_POS = { x: -50, z: 95 }; // æ­£é—¨
        const EXIT_POS = { x: 125, z: 75 };   // è¥¿é—¨

        // --- çœŸå®æ™¯ç‚¹æ•°æ® (åŸºäºæ–°åœ°å›¾) ---
        const rawSpots = [
            // æ ¸å¿ƒçƒ­é—¨åŒº (ä¸­éƒ¨/å—éƒ¨)
            { id: '1', name: 'æ¸©å®¤ç¾¤æ™¯åŒº', type: 'indoor', x: 20, z: 25, access: 'elevator', sensitive: false, time: 60, desc: 'äºšæ´²å¤§å‹æ¸©å®¤ç¾¤ï¼ŒåŒ…å«çƒ­å¸¦é›¨æ—å®¤ã€æ²™æ¼ æ¤ç‰©å®¤ã€é«˜å±±æ¤ç‰©å®¤ã€‚', similarId: '14', imgSeed: 101 },
            { id: '2', name: 'é¾™æ´çªæ—', type: 'outdoor', x: -90, z: 70, access: 'flat', sensitive: true, time: 40, desc: 'â€œç¾ŠåŸå…«æ™¯â€ä¹‹ä¸€ï¼Œä¸€è¾¹æ˜¯æ¤°é£è‘µéŸµï¼Œä¸€è¾¹æ˜¯è½ç¾½æ‰æ°´æ¾ã€‚', similarId: '10', imgSeed: 102 },
            { id: '10', name: 'ä¸­å¿ƒå¤§è‰åª', type: 'outdoor', x: -60, z: 10, access: 'flat', sensitive: true, time: 40, desc: 'è§†é‡å¼€é˜”ï¼Œç»¿è‰å¦‚èŒµï¼Œä½äºè¡Œæ”¿åŠå…¬æ¥¼å‰æ–¹ã€‚', similarId: '2', imgSeed: 110 },
            { id: '14', name: 'ç§‘æ™®ä¿¡æ¯ä¸­å¿ƒ', type: 'indoor', x: -30, z: 0, access: 'elevator', sensitive: false, time: 40, desc: 'ä½äºå›­åŒºä¸­éƒ¨ï¼Œæä¾›ä¸°å¯Œçš„æ¤ç‰©ç§‘æ™®å±•è§ˆã€‚', similarId: '1', imgSeed: 114 },
            
            // ä¸œéƒ¨åŒºåŸŸ (å³ä¾§)
            { id: '18', name: 'æ¾³æ´²æ¤ç‰©å›­', type: 'outdoor', x: 100, z: 40, access: 'flat', sensitive: false, time: 30, desc: 'å±•ç¤ºæ¥è‡ªæ¾³æ´²çš„ç‰¹è‰²æ¤ç‰©ï¼Œå¦‚æ¡‰æ ‘ã€ç“¶å¹²æ ‘ç­‰ã€‚', similarId: '19', imgSeed: 118 },
            { id: '19', name: 'èƒ½æºæ¤ç‰©å›­', type: 'outdoor', x: 110, z: 10, access: 'flat', sensitive: false, time: 20, desc: 'å±•ç¤ºå¯ç”¨äºç”Ÿäº§ç”Ÿç‰©èƒ½æºçš„æ¤ç‰©èµ„æºã€‚', similarId: '18', imgSeed: 119 },
            { id: '3', name: 'å¹¿å·ç¬¬ä¸€æ‘', type: 'outdoor', x: 80, z: -30, access: 'stairs', sensitive: true, time: 30, desc: 'æ–°çŸ³å™¨æ—¶ä»£é—å€ï¼Œæ¨¡æ‹Ÿäº†å²å‰äººç±»çš„ç”Ÿæ´»åœºæ™¯ã€‚', similarId: '26', imgSeed: 103 },
            { id: '11', name: 'æ°´ç”Ÿæ¤ç‰©å›­', type: 'outdoor', x: 30, z: -20, access: 'flat', sensitive: true, time: 25, desc: 'å±•ç¤ºå„ç±»æ°´ç”Ÿæ¤ç‰©ï¼Œè·èŠ±ç¡è²ç››å¼€æ—¶ç¾ä¸èƒœæ”¶ã€‚', similarId: '2', imgSeed: 111 },
            { id: '26', name: 'æ¨±èŠ±å›­', type: 'outdoor', x: 55, z: -45, access: 'slope', sensitive: false, time: 25, desc: 'æ˜¥å­£èµæ¨±èƒœåœ°ï¼Œä½äºé£é¹…ä¸€æ¡¥é™„è¿‘ã€‚', similarId: '12', imgSeed: 126 },
            
            // è¥¿éƒ¨åŒºåŸŸ (å·¦ä¾§)
            { id: '5', name: 'è¯ç”¨æ¤ç‰©å›­', type: 'outdoor', x: -120, z: -10, access: 'flat', sensitive: false, time: 35, desc: 'å±•ç¤ºå„ç±»ä¸­è‰è¯æ¤ç‰©ï¼Œä½äºå—è¯è·¯æ—ã€‚', similarId: '8', imgSeed: 105 },
            { id: '17', name: 'å‡¤æ¢¨å›­', type: 'outdoor', x: -130, z: 10, access: 'flat', sensitive: true, time: 20, desc: 'å±•ç¤ºå½¢æ€å„å¼‚çš„å‡¤æ¢¨ç§‘æ¤ç‰©ï¼Œè‰²å½©æ–‘æ–“ã€‚', similarId: '1', imgSeed: 117 },
            { id: '21', name: 'è’²å²—è‡ªç„¶æ•™è‚²å¾„', type: 'outdoor', x: -120, z: 50, access: 'stairs', sensitive: true, time: 50, desc: 'ä¿ç•™äº†åŸå§‹çš„å­£é£å¸¸ç»¿é˜”å¶æ—ï¼Œé€‚åˆå¾’æ­¥ã€‚', similarId: '2', imgSeed: 121 },
            { id: '8', name: 'å…°å›­', type: 'outdoor', x: -90, z: -20, access: 'flat', sensitive: true, time: 30, desc: 'å…°èŠ±å“ç§ç¹å¤šï¼Œå›­æ—è®¾è®¡é›…è‡´ï¼Œæ›²å¾„é€šå¹½ã€‚', similarId: '5', imgSeed: 108 },
            { id: '9', name: 'è‹é“å›­', type: 'outdoor', x: -70, z: -20, access: 'flat', sensitive: false, time: 20, desc: 'æ”¶é›†äº†å¤§é‡çç¨€è‹é“å“ç§ï¼Œæ¤ç‰©ç•Œçš„â€œæ´»åŒ–çŸ³â€ã€‚', similarId: '13', imgSeed: 109 },
            { id: '20', name: 'è£¸å­æ¤ç‰©åŒº', type: 'outdoor', x: -50, z: -20, access: 'slope', sensitive: true, time: 25, desc: 'å±•ç¤ºæ¾æŸç­‰è£¸å­æ¤ç‰©ï¼Œç¯å¢ƒé™è°§ã€‚', similarId: '9', imgSeed: 120 },

            // åŒ—éƒ¨åŒºåŸŸ (ä¸Šæ–¹)
            { id: '4', name: 'æœ¨å…°å›­', type: 'outdoor', x: -20, z: -90, access: 'slope', sensitive: false, time: 30, desc: 'æœ¨å…°ç§‘æ¤ç‰©æ•°é‡å±…ä¸–ç•Œå‰åˆ—ï¼ŒèŠ±å¼€æ—¶èŠ‚é¦™æ°”è¢­äººã€‚', similarId: '7', imgSeed: 104 },
            { id: '6', name: 'ç«¹å›­', type: 'outdoor', x: 10, z: -80, access: 'slope', sensitive: false, time: 25, desc: 'æ¸…é£å¾æ¥ï¼Œç«¹å½±å©†å¨‘ï¼Œå¤å­£é¿æš‘å¥½å»å¤„ã€‚', similarId: '16', imgSeed: 106 },
            { id: '7', name: 'å§œå›­', type: 'outdoor', x: 40, z: -60, access: 'slope', sensitive: false, time: 30, desc: 'ä¸–ç•ŒçŸ¥åçš„å§œç§‘æ¤ç‰©ä¿è‚²åŸºåœ°ï¼ŒèŠ±å‹å¥‡ç‰¹ã€‚', similarId: '4', imgSeed: 107 },
            { id: '16', name: 'è—¤æœ¬å›­', type: 'outdoor', x: -30, z: -40, access: 'flat', sensitive: false, time: 25, desc: 'å„ç§æ”€æ´æ¤ç‰©ï¼Œæ„å»ºäº†ç‹¬ç‰¹çš„å‚ç›´ç»¿åŒ–æ™¯è§‚ã€‚', similarId: '6', imgSeed: 116 },
            { id: '13', name: 'ç”Ÿç‰©å›­', type: 'outdoor', x: 0, z: -30, access: 'flat', sensitive: false, time: 30, desc: 'å±•ç¤ºæ¤ç‰©è¿›åŒ–ä¸åˆ†ç±»ï¼Œç§‘æ™®æ€§å¼ºã€‚', similarId: '9', imgSeed: 113 },
            { id: '29', name: 'ç»¿ç¾å¹¿ä¸œæ¤ç‰©å±•ç¤ºå›­', type: 'outdoor', x: -50, z: -40, access: 'flat', sensitive: false, time: 30, desc: 'æ–°è®¾å±•åŒºï¼Œå±•ç¤ºå¹¿ä¸œæœ¬åœŸç‰¹è‰²æ¤ç‰©èµ„æºã€‚', similarId: '13', imgSeed: 129 },

            // å—éƒ¨åŒºåŸŸ (æ­£é—¨é™„è¿‘)
            { id: '22', name: 'æ£•æ¦ˆå›­', type: 'outdoor', x: -60, z: 80, access: 'flat', sensitive: false, time: 30, desc: 'é«˜å¤§çš„æ¤°å­æ ‘ã€ç‹æ£•ç­‰ï¼Œå……æ»¡çƒ­å¸¦é£æƒ…ã€‚', similarId: '2', imgSeed: 127 },
            { id: '23', name: 'å­‘é—æ¤ç‰©åŒº', type: 'outdoor', x: -80, z: 80, access: 'flat', sensitive: false, time: 20, desc: 'å±•ç¤ºæ°´æ‰ã€é“¶æç­‰å¤è€å­‘é—æ¤ç‰©ã€‚', similarId: '2', imgSeed: 123 },
            { id: '30', name: 'ç»æµæ¤ç‰©åŒº', type: 'outdoor', x: -30, z: 70, access: 'flat', sensitive: false, time: 25, desc: 'å±•ç¤ºå…·æœ‰ç»æµä»·å€¼çš„æ¤ç‰©ï¼Œå¦‚æ©¡èƒ¶ã€æ²¹æ–™æ¤ç‰©ç­‰ã€‚', similarId: '5', imgSeed: 130 },
            { id: '31', name: 'ç¨€æ ‘è‰åª', type: 'outdoor', x: 10, z: 50, access: 'flat', sensitive: true, time: 20, desc: 'å¼€é˜”çš„è‰åªï¼Œç‚¹ç¼€ç€ç¨€ç–çš„ä¹”æœ¨ï¼Œé€‚åˆé‡é¤ã€‚', similarId: '10', imgSeed: 131 },

            // ä¸œå—åŒºåŸŸ (è¥¿é—¨é™„è¿‘)
            { id: '12', name: 'æœé¹ƒå›­', type: 'outdoor', x: 50, z: 30, access: 'slope', sensitive: false, time: 25, desc: 'æ˜¥å­£æœé¹ƒèŠ±å¼€ï¼Œæ¼«å±±çº¢éï¼Œä½äºæ¸©å®¤ç¾¤æ—ã€‚', similarId: '15', imgSeed: 112 },
            { id: '15', name: 'å±±èŒ¶å›­', type: 'outdoor', x: 50, z: 50, access: 'slope', sensitive: false, time: 30, desc: 'æ”¶é›†å±±èŒ¶å±æ¤ç‰©ï¼ŒèŠ±è‰²ä¸°å¯Œï¼Œå†¬å­£æ˜¥å­£è§‚èµä½³ã€‚', similarId: '12', imgSeed: 115 },
            { id: '24', name: 'åŸå¸‚æ™¯è§‚å›­', type: 'outdoor', x: 80, z: 60, access: 'flat', sensitive: false, time: 25, desc: 'å±•ç¤ºé€‚åˆåŸå¸‚ç»¿åŒ–çš„æ¤ç‰©é…ç½®ä¸ç”Ÿæ€æ™¯è§‚ã€‚', similarId: '10', imgSeed: 124 },
            { id: '32', name: 'ç™¾è‰å›­', type: 'outdoor', x: 120, z: 55, access: 'flat', sensitive: false, time: 20, desc: 'ä½äºè¥¿é—¨é™„è¿‘ï¼Œå±•ç¤ºå¸¸è§è¯è‰ã€‚', similarId: '5', imgSeed: 132 }
        ];

        // æœåŠ¡è®¾æ–½åæ ‡ (æ ¹æ®åœ°å›¾å›¾æ ‡å®šä½)
        const serviceSpots = [
            { name: 'æ­£é—¨æœåŠ¡ç‚¹', x: -50, z: 95 },
            { name: 'è¥¿é—¨æœåŠ¡ç‚¹', x: 125, z: 75 },
            { name: 'æ¸©å®¤é¤é¥®åŒº', x: 30, z: 20 }, // é™„è¿‘æœ‰å’–å•¡æ¯å›¾æ ‡
            { name: 'ç§‘å­¦å®¶ä¹‹å®¶', x: 10, z: 0 },
            { name: 'åŒ—é—¨(å²‘æ‘)', x: 10, z: -100 }
        ];

        // --- å…¨å±€å˜é‡ ---
        let scene, camera, renderer, labelRenderer, controls;
        let spots = [], clickableObjects = [], labelObjects = {};
        let routeMesh, avatar, rainSystem, ambientLight, dirLight;
        let mapPlane; // åœ°å›¾å¹³é¢å¼•ç”¨
        let raycaster = new THREE.Raycaster(), pointer = new THREE.Vector2();
        
        // çŠ¶æ€
        let currentWeather = 'clear';
        let isAccessMode = false;
        let isElevatorBroken = false;
        let isSurgeActive = false;
        let congestedSpotId = null;
        let pendingRoute = [];

        init();
        animate();

        function init() {
            const container = document.getElementById('canvas-container');
            initData();

            // åœºæ™¯åˆå§‹åŒ–
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xeef2f5);
            scene.fog = new THREE.Fog(0xeef2f5, 100, 500);

            // ç›¸æœº
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 280, 200); // è§†è§’æ‹‰é«˜
            camera.lookAt(0, 0, 0);

            // æ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            labelRenderer = new CSS2DRenderer();
            labelRenderer.setSize(window.innerWidth, window.innerHeight);
            labelRenderer.domElement.style.position = 'absolute';
            labelRenderer.domElement.style.top = '0px';
            labelRenderer.domElement.style.pointerEvents = 'none';
            container.appendChild(labelRenderer.domElement);

            // æ§åˆ¶å™¨
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.maxPolarAngle = Math.PI / 2 - 0.1;
            controls.minDistance = 50;
            controls.maxDistance = 500;

            // ç¯å…‰
            ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(100, 200, 100);
            dirLight.castShadow = true;
            dirLight.shadow.camera.left = -200; dirLight.shadow.camera.right = 200;
            dirLight.shadow.camera.top = 200; dirLight.shadow.camera.bottom = -200;
            dirLight.shadow.mapSize.width = 2048; dirLight.shadow.mapSize.height = 2048;
            scene.add(dirLight);

            // æ„å»ºä¸–ç•Œ
            createMapFromUrl('https://i.imgur.com/v5j5zXN.jpeg'); 
            createSpots();
            createRain();
            createAvatar();
            initUI();

            window.addEventListener('resize', onResize);
            window.addEventListener('pointerdown', onPointerDown);
        }

        function initData() {
            spots = rawSpots.map(s => ({ ...s, isCongested: false, queueTime: 0 }));
        }

        // --- åœ°å›¾å¤„ç†é€»è¾‘ ---
        function createMapFromUrl(url) {
            const loader = new THREE.TextureLoader();
            loader.crossOrigin = 'anonymous'; // å°è¯•å¤„ç†è·¨åŸŸ
            loader.load(url, function(texture) {
                texture.colorSpace = THREE.SRGBColorSpace;
                applyMapTexture(texture);
            }, undefined, function(err) {
                console.error("åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ä¸Šä¼ ", err);
                // å¦‚æœåŠ è½½å¤±è´¥ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤çš„å ä½å›¾
                createDefaultPlaceholder();
            });
        }

        function createDefaultPlaceholder() {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#a3d5a3'; ctx.fillRect(0,0,512,512);
            ctx.fillStyle = '#333'; ctx.font = '30px Arial'; ctx.fillText("åœ°å›¾åŠ è½½ä¸­...", 150, 256);
            const texture = new THREE.CanvasTexture(canvas);
            applyMapTexture(texture);
        }

        function applyMapTexture(texture) {
            if(mapPlane) scene.remove(mapPlane);
            
            const geometry = new THREE.PlaneGeometry(MAP_WIDTH, MAP_HEIGHT);
            const material = new THREE.MeshStandardMaterial({ 
                map: texture, 
                roughness: 0.8,
                side: THREE.DoubleSide
            });
            mapPlane = new THREE.Mesh(geometry, material);
            mapPlane.rotation.x = -Math.PI / 2;
            mapPlane.receiveShadow = true;
            scene.add(mapPlane);
            
            // é‡æ–°æ·»åŠ è¾¹ç•Œçº¿ (ç¨å¾®æŠ¬é«˜ä¸€ç‚¹é˜²æ­¢z-fighting)
            const border = new THREE.LineSegments(
                new THREE.EdgesGeometry(geometry),
                new THREE.LineBasicMaterial({ color: 0x666666 })
            );
            border.rotation.x = -Math.PI / 2;
            border.position.y = 0.2; 
            scene.add(border);
        }

        // ç›‘å¬æ–‡ä»¶ä¸Šä¼ 
        document.getElementById('map-upload-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;
            
            const url = URL.createObjectURL(file);
            createMapFromUrl(url);
        });

        function createSpots() {
            spots.forEach(spot => {
                // 3D æ ‡è®°ç‚¹
                let color = spot.type === 'indoor' ? 0x9b59b6 : 0x27ae60;
                if (spot.access === 'stairs') color = 0xe67e22; 
                
                // ç¨å¾®ç¼©å°ä¸€ç‚¹å‡ ä½•ä½“ï¼Œä»¥å…é®æŒ¡åœ°å›¾å¤ªå¤š
                const geometry = spot.type === 'indoor' 
                    ? new THREE.BoxGeometry(4, 6, 4) 
                    : new THREE.ConeGeometry(2.5, 7, 5);
                
                const material = new THREE.MeshStandardMaterial({ color: color });
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(spot.x, 3.5, spot.z);
                mesh.castShadow = true;
                mesh.userData = { isSpot: true, id: spot.id };
                
                scene.add(mesh);
                clickableObjects.push(mesh);

                // CSS2D æ ‡ç­¾
                const div = document.createElement('div');
                div.className = 'label';
                div.innerHTML = `<b>${spot.name}</b>`;
                const label = new CSS2DObject(div);
                label.position.set(0, 8, 0);
                mesh.add(label);
                labelObjects[spot.id] = div;
            });

            // æœåŠ¡è®¾æ–½æ ‡è®°
            serviceSpots.forEach(s => {
                const mesh = new THREE.Mesh(
                    new THREE.CylinderGeometry(1.5, 1.5, 1),
                    new THREE.MeshBasicMaterial({ color: 0x3498db })
                );
                mesh.position.set(s.x, 1, s.z);
                scene.add(mesh);
                
                const div = document.createElement('div');
                div.className = 'label service-label';
                div.innerHTML = s.name;
                const label = new CSS2DObject(div);
                label.position.set(0, 4, 0);
                mesh.add(label);
            });
        }

        // --- äº¤äº’é€»è¾‘ ---
        function onPointerDown(event) {
            if (event.target.closest('#ui-panel') || event.target.closest('.label')) return;
            pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
            pointer.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(pointer, camera);
            const intersects = raycaster.intersectObjects(clickableObjects);
            if (intersects.length > 0) {
                showDetail(intersects[0].object.userData.id);
            }
        }

        window.showDetail = function(id) {
            const spot = spots.find(s => s.id === id);
            if (!spot) return;

            const modal = document.getElementById('detail-modal');
            document.getElementById('modal-title').innerText = spot.name;
            document.getElementById('modal-desc').innerText = spot.desc;
            
            // ç”Ÿæˆæ¨¡æ‹ŸçœŸå®å›¾ç‰‡
            document.getElementById('modal-img').src = `https://picsum.photos/seed/${spot.imgSeed}/400/250`;

            // æ ‡ç­¾ç”Ÿæˆ
            let tags = '';
            if(spot.type === 'indoor') tags += '<span class="badge badge-indoor">ğŸ  å®¤å†…</span> ';
            else tags += '<span class="badge badge-outdoor">ğŸŒ³ æˆ·å¤–</span> ';
            
            if(spot.access === 'elevator') tags += '<span class="badge badge-elevator">ğŸ›— æœ‰ç”µæ¢¯</span> ';
            if(spot.access === 'stairs') tags += '<span class="badge badge-stairs">ğŸªœ éœ€çˆ¬æ¢¯</span> ';
            
            document.getElementById('modal-tags').innerHTML = tags;
            modal.style.display = 'block';
        };
        window.closeModal = () => document.getElementById('detail-modal').style.display = 'none';

        // --- ä¸šåŠ¡é€»è¾‘ ---
        window.setWeather = function(type, btn) {
            currentWeather = type;
            document.querySelectorAll('.weather-btn').forEach(b => b.className = 'weather-btn');
            if(type === 'hot') btn.classList.add('active-hot');
            else if(type === 'rain') btn.classList.add('active-rain');
            else btn.classList.add('active');

            // è§†è§‰æ•ˆæœ
            if(type === 'rain') {
                scene.fog.color.setHex(0xaab7b8); scene.background.setHex(0xaab7b8);
                rainSystem.visible = true;
            } else if (type === 'hot') {
                scene.fog.color.setHex(0xfff0d0); scene.background.setHex(0xfff0d0);
                rainSystem.visible = false;
                dirLight.intensity = 1.5;
            } else {
                scene.fog.color.setHex(0xeef2f5); scene.background.setHex(0xeef2f5);
                rainSystem.visible = false;
                dirLight.intensity = 0.8;
            }
            updateListUI();
        };

        window.toggleElevatorFault = function() {
            isElevatorBroken = !isElevatorBroken;
            document.getElementById('btn-fault').classList.toggle('active');
            updateListUI();
            updateLabels();
        };

        window.toggleSurge = function() {
            isSurgeActive = !isSurgeActive;
            const btn = document.getElementById('btn-surge');
            const status = document.getElementById('congestion-val');
            
            if(isSurgeActive) {
                btn.classList.add('active');
                btn.innerText = "ğŸ”¥ æ­£åœ¨æ¨¡æ‹Ÿå®¢æµæ¿€å¢";
                status.innerText = "æåº¦æ‹¥å µ"; status.style.color = "#e74c3c";
                spots.forEach(s => {
                    if(s.id === '1' || s.id === '2' || s.id === '10') { s.isCongested = true; s.queueTime = Math.floor(Math.random()*40)+30; }
                });
            } else {
                btn.classList.remove('active');
                btn.innerText = "ğŸ”¥ æ¨¡æ‹ŸèŠ‚å‡æ—¥å®¢æµæ¿€å¢";
                status.innerText = "èˆ’é€‚"; status.style.color = "#27ae60";
                spots.forEach(s => { s.isCongested = false; s.queueTime = 0; });
            }
            updateListUI();
            updateLabels();
        };

        function updateLabels() {
            spots.forEach(s => {
                const div = labelObjects[s.id];
                if(!div) return;
                
                if(s.isCongested) {
                    div.className = 'label congested-label';
                    div.innerHTML = `<b>${s.name}</b><br>ğŸ”¥ æ’é˜Ÿ${s.queueTime}åˆ†`;
                } else if (s.access === 'elevator' && isElevatorBroken) {
                    div.className = 'label congested-label'; 
                    div.innerHTML = `<b>${s.name}</b><br>âš ï¸ ç”µæ¢¯æ•…éšœ`;
                } else {
                    div.className = 'label';
                    div.innerHTML = `<b>${s.name}</b>`;
                }
            });
        }

        function updateListUI() {
            const container = document.getElementById('spots-container');
            container.innerHTML = '';
            
            spots.forEach(s => {
                let disabled = false;
                let badges = '';
                
                if(currentWeather === 'rain' && s.sensitive) { disabled = true; badges += '<span class="badge badge-queue">é›¨å¤©å…³é—­</span>'; }
                if(isAccessMode && s.access === 'stairs') { disabled = true; badges += '<span class="badge badge-stairs">ğŸš«å°é˜¶</span>'; }
                if(isAccessMode && s.access === 'elevator' && isElevatorBroken) { disabled = true; badges += '<span class="badge badge-queue">âš ï¸æ¢¯å</span>'; }
                if(s.isCongested) badges += `<span class="badge badge-queue">æ’é˜Ÿ${s.queueTime}m</span>`;

                const div = document.createElement('div');
                div.className = `spot-item ${disabled ? 'disabled' : ''} ${s.isCongested ? 'congested' : ''}`;
                div.id = `item-${s.id}`;
                div.innerHTML = `
                    <input type="checkbox" class="spot-checkbox" data-id="${s.id}" ${disabled ? 'disabled' : ''}>
                    <div class="spot-content" onclick="showDetail('${s.id}')">
                        <div class="spot-name">${s.name}</div>
                        <div class="spot-meta">${badges} <span>â±ï¸${s.time}m</span></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- è·¯å¾„è§„åˆ’ ---
        window.clearSelection = () => {
            document.querySelectorAll('.spot-checkbox').forEach(c => c.checked = false);
            if(routeMesh) scene.remove(routeMesh);
            avatar.visible = false;
        };

        document.getElementById('btn-plan').addEventListener('click', () => {
            const checked = Array.from(document.querySelectorAll('.spot-checkbox:checked')).map(c => c.dataset.id);
            if(checked.length === 0) return;

            const selectedSpots = spots.filter(s => checked.includes(s.id));
            
            const congested = selectedSpots.find(s => s.isCongested);
            if(congested) {
                congestedSpotId = congested.id;
                pendingRoute = selectedSpots;
                const alt = spots.find(s => s.id === congested.similarId);
                
                document.getElementById('warn-spot-name').innerText = congested.name;
                document.getElementById('alt-spot-name').innerText = alt ? alt.name : 'å…¶ä»–åŒºåŸŸ';
                document.getElementById('decision-modal').style.display = 'block';
                return;
            }

            drawRoute(selectedSpots);
        });

        window.userDecision = function(choice) {
            document.getElementById('decision-modal').style.display = 'none';
            let finalSpots = [...pendingRoute];
            
            if(choice === 'reroute') {
                const idx = finalSpots.findIndex(s => s.id === congestedSpotId);
                const bad = finalSpots[idx];
                const good = spots.find(s => s.id === bad.similarId);
                if(good) {
                    finalSpots[idx] = good;
                    const alert = document.getElementById('alert-info');
                    alert.style.display = 'block';
                    alert.innerHTML = `âœ… å·²è‡ªåŠ¨å°† <b>${bad.name}</b> æ›¿æ¢ä¸º <b>${good.name}</b>ï¼Œè¡Œç¨‹æ›´é¡ºç•…ã€‚`;
                }
            }
            drawRoute(finalSpots);
        };

        function drawRoute(routeSpots) {
            if(routeMesh) scene.remove(routeMesh);

            let sorted = [START_POS];
            let remaining = [...routeSpots];
            let current = START_POS;
            
            // ç®€å•çš„æœ€è¿‘é‚»ç®—æ³•æ’åº
            while(remaining.length > 0) {
                let nearestIdx = 0;
                let minD = Infinity;
                remaining.forEach((s, i) => {
                    const d = Math.hypot(s.x - current.x, s.z - current.z);
                    if(d < minD) { minD = d; nearestIdx = i; }
                });
                sorted.push(remaining[nearestIdx]);
                current = remaining[nearestIdx];
                remaining.splice(nearestIdx, 1);
            }
            sorted.push(EXIT_POS);

            const points = sorted.map(p => new THREE.Vector3(p.x, 2, p.z));
            const curve = new THREE.CatmullRomCurve3(points);
            const tube = new THREE.TubeGeometry(curve, 100, 0.6, 8, false);
            const mat = new THREE.MeshBasicMaterial({ color: isAccessMode ? 0x16a085 : 0x3498db });
            
            routeMesh = new THREE.Mesh(tube, mat);
            scene.add(routeMesh);

            animateAvatar(curve);
        }

        // --- è¾…åŠ©åŠŸèƒ½ ---
        function createRain() {
            const geo = new THREE.BufferGeometry();
            const pos = [];
            for(let i=0; i<5000; i++) pos.push(Math.random()*400-200, Math.random()*200, Math.random()*400-200);
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            rainSystem = new THREE.Points(geo, new THREE.PointsMaterial({color:0xaaaaaa, size:0.5, transparent:true}));
            rainSystem.visible = false;
            scene.add(rainSystem);
        }

        function createAvatar() {
            avatar = new THREE.Mesh(new THREE.SphereGeometry(2), new THREE.MeshBasicMaterial({color:0xe67e22}));
            avatar.visible = false;
            scene.add(avatar);
        }

        let avatarCurve = null, avatarProgress = 0;
        function animateAvatar(curve) {
            avatarCurve = curve;
            avatarProgress = 0;
            avatar.visible = true;
        }

        function initUI() {
            document.getElementById('access-mode-toggle').addEventListener('change', (e) => {
                isAccessMode = e.target.checked;
                updateListUI();
            });
            updateListUI();
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            labelRenderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            labelRenderer.render(scene, camera);
            renderer.render(scene, camera);

            if(rainSystem && rainSystem.visible) {
                const pos = rainSystem.geometry.attributes.position.array;
                for(let i=1; i<pos.length; i+=3) {
                    pos[i] -= 2;
                    if(pos[i] < 0) pos[i] = 200;
                }
                rainSystem.geometry.attributes.position.needsUpdate = true;
            }

            if(avatar.visible && avatarCurve) {
                avatarProgress += 0.002;
                if(avatarProgress > 1) avatarProgress = 0;
                const pt = avatarCurve.getPointAt(avatarProgress);
                avatar.position.copy(pt);
            }
        }
    </script>
</body>
</html>