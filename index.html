<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§åå—å›½å®¶æ¤ç‰©å›­ - AIå¢å¼ºç‰ˆ</title>
    <style>
        /* --- åŸºç¡€é‡ç½® --- */
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; color: #333; }
        #canvas-container { width: 100vw; height: 100vh; display: block; background: #e0e8ec; }

        /* --- é¡¶éƒ¨ LED è·‘é©¬ç¯ --- */
        #digital-signage {
            position: absolute; top: 0; left: 0; width: 100%; height: 36px;
            background: #2c3e50; color: #f39c12; z-index: 20;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Courier New', monospace; font-size: 14px; font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            overflow: hidden; white-space: nowrap;
            transition: top 0.3s;
        }
        #digital-signage.hidden { top: -50px; }
        .led-text { animation: marquee 20s linear infinite; padding-left: 100%; display: inline-block; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

        /* --- å·¦ä¾§ UI é¢æ¿ (å¼¹æ€§å¸ƒå±€é‡æ„) --- */
        #ui-panel {
            position: absolute; top: 36px; left: 0; bottom: 0; width: 360px;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 4px 0 20px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; z-index: 10;
            border-right: 1px solid #ddd; backdrop-filter: blur(10px);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #ui-panel.collapsed { transform: translateX(-100%); }

        /* ä¾§è¾¹æ å¼€å…³ */
        #ui-toggle-btn {
            position: absolute; top: 50%; right: -24px; margin-top: -20px;
            width: 24px; height: 60px;
            background: white; border-radius: 0 8px 8px 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 14px; color: #27ae60;
            z-index: 11; border: 1px solid #ddd; border-left: none;
        }

        /* å¤´éƒ¨åŒºåŸŸ */
        .panel-header { 
            padding: 15px 20px; 
            background: linear-gradient(135deg, #11998e, #38ef7d); 
            color: white; flex-shrink: 0; 
        }
        .panel-header h2 { margin: 0; font-size: 18px; letter-spacing: 1px; }
        .panel-header p { margin: 5px 0 0; font-size: 11px; opacity: 0.9; }

        /* åŠŸèƒ½æ¨¡å—å®¹å™¨ (å¯æ»šåŠ¨) */
        .modules-container {
            flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* æŠ˜å èœå•æ ·å¼ */
        .accordion-item { border-bottom: 1px solid #eee; }
        .accordion-header {
            padding: 12px 15px; background: #f8f9fa; cursor: pointer;
            font-size: 13px; font-weight: bold; color: #444;
            display: flex; justify-content: space-between; align-items: center;
            transition: background 0.2s;
        }
        .accordion-header:hover { background: #f1f1f1; }
        .accordion-content {
            display: none; padding: 10px 15px; background: white;
        }
        .accordion-item.active .accordion-content { display: block; animation: slideDown 0.3s ease; }
        .accordion-item.active .accordion-header { color: #16a085; border-left: 4px solid #16a085; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* æ§ä»¶æ ·å¼ */
        .btn-group { display: flex; gap: 5px; margin-bottom: 5px; }
        .ctrl-btn { flex: 1; padding: 6px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; font-size: 12px; transition: 0.2s; }
        .ctrl-btn:hover { background: #f0f0f0; }
        .ctrl-btn.active { background: #eaf6ff; border-color: #3498db; color: #3498db; font-weight: bold; }
        .ctrl-btn.danger.active { background: #fff5f5; border-color: #e74c3c; color: #e74c3c; }
        
        .surge-control { background: #fff8f0; border: 1px solid #ffe0b2; padding: 10px; border-radius: 6px; margin-top: 5px; }
        .slider-row { display: flex; align-items: center; gap: 10px; margin-top: 5px; font-size: 12px; }
        input[type=range] { flex: 1; }

        /* æ™¯ç‚¹åˆ—è¡¨åŒºåŸŸ (è‡ªé€‚åº”é«˜åº¦) */
        .list-section {
            display: flex; flex-direction: column;
            flex: 1; /* å…³é”®ï¼šè®©å®ƒæ’‘æ»¡å‰©ä½™é«˜åº¦ */
            min-height: 200px; /* æœ€å°é«˜åº¦é˜²æ­¢å¤ªæ‰ */
            border-top: 4px solid #eee;
        }
        .list-header {
            padding: 10px 15px; font-size: 12px; font-weight: bold; color: #666;
            background: #fff; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
        }
        .spots-scroll-area {
            flex: 1; overflow-y: auto; padding: 5px; background: #fcfcfc;
        }
        
        /* æ™¯ç‚¹å¡ç‰‡ */
        .spot-item {
            display: flex; align-items: center; padding: 8px; margin-bottom: 5px;
            background: white; border-radius: 6px; border: 1px solid #eee;
            transition: 0.2s; cursor: pointer;
        }
        .spot-item:hover { border-color: #27ae60; transform: translateX(2px); }
        .spot-item.congested { border-left: 3px solid #e74c3c; background: #fffbfb; }
        .spot-info { flex: 1; margin-left: 8px; }
        .spot-name { font-size: 13px; font-weight: bold; color: #333; }
        .spot-tags { font-size: 10px; color: #888; margin-top: 2px; display: flex; gap: 4px; }
        .tag { padding: 1px 4px; border-radius: 2px; background: #eee; }
        .tag.red { background: #ffebee; color: #c62828; }
        .tag.green { background: #e8f5e9; color: #2e7d32; }

        /* åº•éƒ¨æ“ä½œåŒº */
        .action-footer {
            padding: 15px; background: white; border-top: 1px solid #eee; flex-shrink: 0;
        }
        #btn-plan {
            width: 100%; padding: 12px; background: #27ae60; color: white;
            border: none; border-radius: 6px; font-size: 14px; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3);
            transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        #btn-plan:hover { background: #219150; }

        /* --- DeepSeek AI èŠå¤©çª—å£ --- */
        #ai-widget {
            position: fixed; bottom: 30px; right: 30px; z-index: 100;
            display: flex; flex-direction: column; align-items: flex-end;
        }
        #ai-toggle {
            width: 60px; height: 60px; border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            box-shadow: 0 5px 20px rgba(118, 75, 162, 0.4);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.3s; color: white; font-size: 28px;
        }
        #ai-toggle:hover { transform: scale(1.1) rotate(10deg); }
        
        #ai-chat-window {
            width: 350px; height: 500px; background: white;
            border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 15px; display: none; flex-direction: column;
            overflow: hidden; border: 1px solid #eee;
            animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popUp { from { opacity: 0; transform: translateY(20px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }

        .chat-header {
            padding: 15px; background: #f8f9fa; border-bottom: 1px solid #eee;
            display: flex; align-items: center; gap: 10px;
        }
        .chat-header img { width: 30px; height: 30px; border-radius: 50%; }
        .chat-title h4 { margin: 0; font-size: 14px; }
        .chat-title span { font-size: 10px; color: #27ae60; }
        
        .chat-body {
            flex: 1; padding: 15px; overflow-y: auto; background: #fff;
            display: flex; flex-direction: column; gap: 10px;
        }
        .msg { max-width: 80%; padding: 10px 12px; border-radius: 12px; font-size: 13px; line-height: 1.5; position: relative; }
        .msg.ai { align-self: flex-start; background: #f0f2f5; color: #333; border-bottom-left-radius: 2px; }
        .msg.user { align-self: flex-end; background: #667eea; color: white; border-bottom-right-radius: 2px; }
        
        .chat-input-area {
            padding: 10px; border-top: 1px solid #eee; display: flex; gap: 8px;
        }
        #chat-input {
            flex: 1; border: 1px solid #ddd; border-radius: 20px; padding: 8px 15px;
            outline: none; font-size: 13px;
        }
        #chat-send {
            background: #667eea; color: white; border: none; width: 36px; height: 36px;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* --- åœ°å›¾æ ‡ç­¾ --- */
        .label { 
            color: #333; padding: 2px 6px; background: rgba(255, 255, 255, 0.9); 
            border-radius: 4px; font-size: 11px; pointer-events: none; 
            text-align: center; border: 1px solid #999; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.15); 
            margin-top: -10px; 
        }
        .label b { display: block; font-size: 12px; }
        .entrance-label { background: #2c3e50; color: white; border: 2px solid white; z-index: 50; }
        .congested-label { background: #c0392b !important; color: white !important; z-index: 100; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* --- å†³ç­–å¼¹çª— --- */
        #decision-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 400px; background: white; border-radius: 12px; z-index: 9999;
            box-shadow: 0 25px 60px rgba(0,0,0,0.4); display: none;
            border-top: 6px solid #e74c3c;
        }
        .modal-body { padding: 20px; text-align: center; }
        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .btn-choice { flex: 1; padding: 10px; border-radius: 6px; cursor: pointer; border: 1px solid #ddd; }
        .btn-choice:hover { background: #f9f9f9; }
        
    </style>
    <!-- å¼•å…¥ Three.js -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <!-- é¡¶éƒ¨è·‘é©¬ç¯ -->
    <div id="digital-signage">
        <div class="led-text" id="signage-text">æ¬¢è¿å…‰ä¸´åå—å›½å®¶æ¤ç‰©å›­ã€‚ä»Šæ—¥æ°”å€™å®œäººï¼Œé€‚å®œæ¸¸è§ˆã€‚è¯·æ³¨æ„çˆ±æŠ¤èŠ±è‰ï¼Œæ–‡æ˜å‡ºè¡Œã€‚</div>
    </div>

    <!-- å·¦ä¾§åŠŸèƒ½é¢æ¿ -->
    <div id="ui-panel">
        <div id="ui-toggle-btn" onclick="togglePanel()">â—€</div>

        <div class="panel-header">
            <h2>ğŸŒ¿ æ™ºæ…§åå—å›½å®¶æ¤ç‰©å›­</h2>
            <p>Interactive Map & AI Guide</p>
        </div>

        <!-- åŠŸèƒ½æ¨¡å— (æ‰‹é£ç´ç»“æ„) -->
        <div class="modules-container">
            
            <!-- æ¨¡å—1: æ°”è±¡ä¸ç¯å¢ƒ -->
            <div class="accordion-item active">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>ğŸŒ¤ï¸ ç¯å¢ƒä¸æ°”è±¡</span> <span>â–¼</span>
                </div>
                <div class="accordion-content">
                    <div class="btn-group">
                        <button class="ctrl-btn active" onclick="setWeather('clear', this)">â˜€ï¸ æ™´æœ—</button>
                        <button class="ctrl-btn" onclick="setWeather('rain', this)">ğŸŒ§ï¸ é™é›¨</button>
                        <button class="ctrl-btn" onclick="setWeather('evening', this)">ğŸŒ™ å‚æ™š</button>
                    </div>
                    <div style="margin-top:8px; display:flex; justify-content:space-between; font-size:12px;">
                        <span>æ— éšœç¢æ¨¡å¼</span>
                        <input type="checkbox" id="access-toggle" onchange="toggleAccessMode(this)">
                    </div>
                </div>
            </div>

            <!-- æ¨¡å—2: å›­åŠ¡ç®¡ç† (æ¨¡æ‹Ÿ) -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>ğŸ“Š å›­åŠ¡ç®¡ç† (æ¨¡æ‹Ÿä¸­å¿ƒ)</span> <span>â–¼</span>
                </div>
                <div class="accordion-content">
                    <button class="ctrl-btn danger" id="btn-surge" style="width:100%" onclick="toggleSurge()">ğŸ”¥ æ¨¡æ‹ŸèŠ‚å‡æ—¥å®¢æµæ¿€å¢</button>
                    
                    <!-- åªæœ‰ç‚¹å‡»æ¨¡æ‹Ÿåæ‰ä¼šæ˜¾ç¤ºçš„è¯¦ç»†æ§ä»¶ -->
                    <div id="surge-controls" class="surge-control" style="display:none;">
                        <div style="font-size:11px; color:#d35400; font-weight:bold; margin-bottom:5px;">âš ï¸ æ‹¥å µé¢„è­¦å·²ç”Ÿæ•ˆ</div>
                        <div class="slider-row">
                            <span>åˆ†æµå¼ºåº¦</span>
                            <input type="range" min="0" max="100" value="0" oninput="updateDiversion(this.value)">
                            <span id="diversion-val">0%</span>
                        </div>
                        <div style="font-size:10px; color:#666; margin-top:4px;">é¢„è®¡æ¶ˆæ•£æ—¶é—´: <span id="est-time">60</span> åˆ†é’Ÿ</div>
                    </div>

                    <button class="ctrl-btn" style="width:100%; margin-top:8px;" onclick="toggleMaintenance()">ğŸ› ï¸ æ¨¡æ‹Ÿè®¾æ–½ç»´æŠ¤ (ç”µæ¢¯)</button>
                </div>
            </div>

            <!-- æ¨¡å—3: åœ°å›¾æ ¡å‡† -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>ğŸ—ºï¸ åœ°å›¾å·¥å…·</span> <span>â–¼</span>
                </div>
                <div class="accordion-content">
                    <label style="display:block; font-size:12px; margin-bottom:5px; cursor:pointer; color:#2980b9;">
                        ğŸ“‚ ä¸Šä¼ æ–°åœ°å›¾åº•å›¾ <input type="file" id="map-upload" style="display:none;" accept="image/*">
                    </label>
                    <button class="ctrl-btn" id="btn-calibrate" style="width:100%" onclick="toggleCalibration()">ğŸ“ å¼€å¯ç‚¹ä½æ‹–æ‹½æ ¡å‡†</button>
                </div>
            </div>

        </div>

        <!-- æ™¯ç‚¹åˆ—è¡¨ (è‡ªåŠ¨å¡«å……å‰©ä½™é«˜åº¦) -->
        <div class="list-section">
            <div class="list-header">
                <span>ğŸ“ æ™¯ç‚¹åˆ—è¡¨ (å·²åŠ è½½38ä¸ªç‚¹ä½)</span>
                <span style="cursor:pointer; color:#3498db;" onclick="clearSelection()">æ¸…ç©º</span>
            </div>
            <div class="spots-scroll-area" id="spots-container">
                <!-- JS ç”Ÿæˆåˆ—è¡¨ -->
            </div>
        </div>

        <!-- åº•éƒ¨æŒ‰é’® -->
        <div class="action-footer">
            <button id="btn-plan" onclick="planRoute()">
                <span>ğŸš€ æ™ºèƒ½è§„åˆ’è·¯çº¿</span>
            </button>
        </div>
    </div>

    <!-- DeepSeek AI æŒ‚ä»¶ -->
    <div id="ai-widget">
        <div id="ai-chat-window">
            <div class="chat-header">
                <div style="width:32px; height:32px; background:#667eea; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold;">DS</div>
                <div class="chat-title">
                    <h4>DeepSeek æ™ºèƒ½å¯¼æ¸¸</h4>
                    <span>â— åœ¨çº¿ | åå—æ¤ç‰©å›­ä¸“å±çŸ¥è¯†åº“</span>
                </div>
                <div style="margin-left:auto; cursor:pointer; font-size:18px;" onclick="toggleChat()">Ã—</div>
            </div>
            <div class="chat-body" id="chat-body">
                <div class="msg ai">æ‚¨å¥½ï¼æˆ‘æ˜¯åå—å›½å®¶æ¤ç‰©å›­çš„ AI æ™ºèƒ½å¯¼æ¸¸ã€‚æ‚¨å¯ä»¥é—®æˆ‘å…³äºé—¨ç¥¨ã€èŠ±æœŸã€è·¯çº¿æ¨èæˆ–ç‰¹å®šæ¤ç‰©çš„é—®é¢˜ã€‚ğŸŒ±</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="è¾“å…¥é—®é¢˜ï¼Œä¾‹å¦‚ï¼šæ¸©å®¤åœ¨å“ªé‡Œï¼Ÿ" onkeypress="handleEnter(event)">
                <button id="chat-send" onclick="sendMessage()">â¤</button>
            </div>
        </div>
        <div id="ai-toggle" onclick="toggleChat()">ğŸ¤–</div>
    </div>

    <!-- å†³ç­–å¼¹çª— -->
    <div id="decision-modal">
        <div class="modal-body">
            <h3 style="color:#c0392b; margin-top:0;">âš ï¸ æ‹¥å µæç¤º</h3>
            <p>æ‚¨é€‰æ‹©çš„ <b>æ¸©å®¤ç¾¤æ™¯åŒº</b> å½“å‰æ¸¸å®¢å¯†åº¦æé«˜ï¼Œé¢„è®¡æ’é˜Ÿ <b>60åˆ†é’Ÿ</b>ã€‚</p>
            <p style="font-size:12px; color:#666;">ç³»ç»Ÿæ£€æµ‹åˆ°é™„è¿‘æœ‰åŒç±»æ™¯è§‚ï¼Œå»ºè®®åˆ†æµã€‚</p>
            <div class="btn-row">
                <div class="btn-choice" onclick="confirmRoute(true)" style="border-color:#e74c3c; background:#fff5f5;">
                    <strong style="color:#c0392b">åšæŒå‰å¾€</strong><br><span style="font-size:10px">ç­‰å¾…æ—¶é—´é•¿</span>
                </div>
                <div class="btn-choice" onclick="confirmRoute(false)" style="border-color:#27ae60; background:#f0fdf4;">
                    <strong style="color:#27ae60">æ™ºèƒ½ç»•è¡Œ</strong><br><span style="font-size:10px">æ¨èï¼šå‰å¾€ç§‘æ™®ä¸­å¿ƒ</span>
                </div>
            </div>
        </div>
    </div>

    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';
        import { DragControls } from 'three/addons/controls/DragControls.js';

        // --- 1. åœ°å›¾æ•°æ®é‡æ„ (åŸºäºæä¾›çš„åœ°å›¾å›¾ç‰‡) ---
        // åæ ‡ç³»å‡è®¾ï¼šä¸­å¿ƒç‚¹(0,0)åœ¨ä¸­å¿ƒå¤§è‰åªã€‚Xè½´å‘å³(ä¸œ)ï¼ŒZè½´å‘ä¸‹(å—)ã€‚
        // åœ°å›¾å°ºå¯¸çº¦ï¼šå®½300ï¼Œé«˜250
        
        const rawSpots = [
            // --- å‡ºå…¥å£ (æ–°å¢) ---
            { id: 'gate_main', name: 'æ­£é—¨ (Main Gate)', type: 'gate', x: -20, z: 120, desc: 'ä½äºå¤©æºè·¯ï¼Œé è¿‘åœ°é“6å·çº¿æ¤ç‰©å›­ç«™ã€‚', img: 'gate' },
            { id: 'gate_west', name: 'è¥¿é—¨ (West Gate)', type: 'gate', x: 140, z: 100, desc: 'ä½äºå…´ç§‘è·¯ï¼Œé è¿‘åœè½¦åœºã€‚', img: 'gate' },
            { id: 'gate_north', name: 'åŒ—é—¨ (å²‘æ‘é—¨)', type: 'gate', x: 0, z: -120, desc: 'ä½äºå²‘æ‘ï¼Œè¾ƒååƒ»ã€‚', img: 'gate' },

            // --- æ ¸å¿ƒæ™¯åŒº (ä½ç½®ä¿®æ­£) ---
            { id: 'conservatory', name: 'æ¸©å®¤ç¾¤æ™¯åŒº', type: 'indoor', x: 50, z: 40, desc: 'åœ°æ ‡æ€§å»ºç­‘ï¼ŒåŒ…å«çƒ­å¸¦é›¨æ—å®¤ã€æ²™æ¼ æ¤ç‰©å®¤ç­‰ã€‚', sensitive: false },
            { id: 'longdong', name: 'é¾™æ´çªæ—', type: 'outdoor', x: -80, z: 70, desc: 'â€œç¾ŠåŸå…«æ™¯â€ä¹‹ä¸€ï¼Œæ™¯è§‚ä¼˜ç¾ã€‚', sensitive: true },
            { id: 'lawn', name: 'ä¸­å¿ƒå¤§è‰åª', type: 'outdoor', x: -30, z: 30, desc: 'å›­åŒºä¸­å¿ƒï¼Œè§†é‡å¼€é˜”ã€‚', sensitive: true },
            { id: 'museum', name: 'ç§‘æ™®ä¿¡æ¯ä¸­å¿ƒ', type: 'indoor', x: -10, z: 20, desc: 'ä½äºä¸­å¿ƒå¤§è‰åªæ—ï¼Œæä¾›ç§‘æ™®å±•è§ˆã€‚', sensitive: false },

            // --- åŒ—éƒ¨åŒºåŸŸ (Top) ---
            { id: 'magnolia', name: 'æœ¨å…°å›­', type: 'outdoor', x: -10, z: -90, desc: 'ä¸–ç•Œè‘—åçš„æœ¨å…°ç§‘æ¤ç‰©ä¿è‚²åŸºåœ°ã€‚', sensitive: false },
            { id: 'bamboo', name: 'ç«¹å›­', type: 'outdoor', x: 20, z: -80, desc: 'æ”¶é›†ç«¹ç±»æ¤ç‰©ä¸°å¯Œã€‚', sensitive: false },
            { id: 'ginger', name: 'å§œå›­', type: 'outdoor', x: 60, z: -60, desc: 'å§œç§‘æ¤ç‰©å±•ç¤ºåŒºã€‚', sensitive: false },
            { id: 'nursery', name: 'å¼•ç§ä¿è‚²ä¸­å¿ƒ', type: 'outdoor', x: -70, z: -70, desc: 'éå¼€æ”¾åŒºï¼Œç§‘ç ”é‡åœ°ã€‚', sensitive: false },

            // --- è¥¿éƒ¨åŒºåŸŸ (Left) ---
            { id: 'medicine', name: 'è¯ç”¨æ¤ç‰©å›­', type: 'outdoor', x: -120, z: 0, desc: 'æ”¶é›†å„ç§è¯ç”¨æ¤ç‰©ã€‚', sensitive: false },
            { id: 'orchid', name: 'å…°å›­', type: 'outdoor', x: -90, z: 10, desc: 'å¹½é™é›…è‡´ï¼Œå…°èŠ±å“ç§ç¹å¤šã€‚', sensitive: true },
            { id: 'cycad', name: 'è‹é“å›­', type: 'outdoor', x: -70, z: 15, desc: 'å¤è€çš„è‹é“æ¤ç‰©ã€‚', sensitive: false },
            { id: 'relic', name: 'å­‘é—æ¤ç‰©åŒº', type: 'outdoor', x: -100, z: 60, desc: 'æ´»åŒ–çŸ³æ¤ç‰©å±•ç¤ºã€‚', sensitive: false },

            // --- ä¸œéƒ¨åŒºåŸŸ (Right) ---
            { id: 'water', name: 'æ°´ç”Ÿæ¤ç‰©å›­', type: 'outdoor', x: 60, z: 0, desc: 'è·èŠ±ã€ç¡è²ç­‰æ°´ç”Ÿæ¤ç‰©ã€‚', sensitive: true },
            { id: 'australia', name: 'æ¾³æ´²æ¤ç‰©å›­', type: 'outdoor', x: 120, z: 50, desc: 'å±•ç¤ºæ¾³æ´²ç‰¹è‰²æ¤ç‰©ã€‚', sensitive: false },
            { id: 'energy', name: 'èƒ½æºæ¤ç‰©å›­', type: 'outdoor', x: 130, z: 30, desc: 'èƒ½æºä½œç‰©å±•ç¤ºã€‚', sensitive: false },
            { id: 'azalea', name: 'æœé¹ƒå›­', type: 'outdoor', x: 90, z: 40, desc: 'æ˜¥å­£æœé¹ƒç››å¼€ã€‚', sensitive: false },
            { id: 'camellia', name: 'å±±èŒ¶å›­', type: 'outdoor', x: 95, z: 55, desc: 'å†¬å­£å±±èŒ¶èŠ±å¼€ã€‚', sensitive: false },

            // --- ä¸­éƒ¨å…¶ä»– ---
            { id: 'vine', name: 'è—¤æœ¬å›­', type: 'outdoor', x: 10, z: -30, desc: 'å„ç§æ”€æ´æ¤ç‰©ã€‚', sensitive: false },
            { id: 'biology', name: 'ç”Ÿç‰©å›­', type: 'outdoor', x: 30, z: -20, desc: 'ç”Ÿç‰©å¤šæ ·æ€§å±•ç¤ºã€‚', sensitive: false },
            { id: 'palm', name: 'æ£•æ¦ˆå›­', type: 'outdoor', x: -60, z: 90, desc: 'çƒ­å¸¦é£æƒ…æµ“éƒã€‚', sensitive: false },
            { id: 'economic', name: 'ç»æµæ¤ç‰©åŒº', type: 'outdoor', x: -10, z: 90, desc: 'å…·æœ‰ç»æµä»·å€¼çš„æ¤ç‰©ã€‚', sensitive: false }
        ];

        // --- å…¨å±€å˜é‡ ---
        let scene, camera, renderer, labelRenderer, controls, dragControls;
        let spots = [], spotMeshes = [], labelObjects = {};
        let routeLine = null;
        let isSurgeMode = false;
        let mapMesh;

        init();
        animate();

        function init() {
            const container = document.getElementById('canvas-container');
            spots = rawSpots.map(s => ({ ...s, isCongested: false }));

            // åœºæ™¯åˆå§‹åŒ–
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xe0e8ec);
            scene.fog = new THREE.Fog(0xe0e8ec, 100, 500);

            // ç›¸æœºè®¾ç½® (ä¿¯è§†è§’åº¦)
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 250, 150); 
            camera.lookAt(0, 0, 20);

            // æ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            // CSS2D æ ‡ç­¾æ¸²æŸ“å™¨
            labelRenderer = new CSS2DRenderer();
            labelRenderer.setSize(window.innerWidth, window.innerHeight);
            labelRenderer.domElement.style.position = 'absolute';
            labelRenderer.domElement.style.top = '0px';
            labelRenderer.domElement.style.pointerEvents = 'none';
            container.appendChild(labelRenderer.domElement);

            // æ§åˆ¶å™¨
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.maxPolarAngle = Math.PI / 2.2;

            // ç¯å…‰
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(50, 100, 50);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // åˆ›å»ºåœ°å›¾åº•æ¿
            createMapPlane();
            // åˆ›å»ºæ™¯ç‚¹æ¨¡å‹
            createSpots();
            // åˆå§‹åŒ– UI åˆ—è¡¨
            renderSpotList();

            window.addEventListener('resize', onResize);
        }

        function createMapPlane() {
            const geometry = new THREE.PlaneGeometry(350, 280);
            const material = new THREE.MeshStandardMaterial({ 
                color: 0xdfe6e9, 
                side: THREE.DoubleSide,
                roughness: 0.8 
            });
            mapMesh = new THREE.Mesh(geometry, material);
            mapMesh.rotation.x = -Math.PI / 2;
            mapMesh.position.y = -0.5;
            mapMesh.receiveShadow = true;
            scene.add(mapMesh);

            // ç®€å•çš„ç½‘æ ¼è¾…åŠ©
            const grid = new THREE.GridHelper(400, 40, 0xcccccc, 0xeeeeee);
            grid.position.y = -0.4;
            scene.add(grid);
        }

        // å¤„ç†åœ°å›¾ä¸Šä¼ 
        document.getElementById('map-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;
            const loader = new THREE.TextureLoader();
            loader.load(URL.createObjectURL(file), (tex) => {
                tex.colorSpace = THREE.SRGBColorSpace;
                mapMesh.material = new THREE.MeshStandardMaterial({ map: tex });
                mapMesh.material.needsUpdate = true;
            });
        });

        function createSpots() {
            spots.forEach(spot => {
                const group = new THREE.Group();
                
                let mesh;
                if (spot.type === 'gate') {
                    // é—¨ï¼šç«‹æ–¹ä½“
                    mesh = new THREE.Mesh(
                        new THREE.BoxGeometry(8, 6, 4),
                        new THREE.MeshStandardMaterial({ color: 0x2c3e50 })
                    );
                    mesh.position.y = 3;
                } else if (spot.type === 'indoor') {
                    // å®¤å†…ï¼šç´«è‰²å…«é¢ä½“
                    mesh = new THREE.Mesh(
                        new THREE.OctahedronGeometry(5),
                        new THREE.MeshStandardMaterial({ color: 0x8e44ad })
                    );
                    mesh.position.y = 5;
                } else {
                    // å®¤å¤–ï¼šç»¿è‰²åœ†é”¥ï¼ˆæ ‘ï¼‰
                    mesh = new THREE.Mesh(
                        new THREE.ConeGeometry(4, 10, 8),
                        new THREE.MeshStandardMaterial({ color: 0x27ae60 })
                    );
                    mesh.position.y = 5;
                }
                
                mesh.castShadow = true;
                group.add(mesh);
                group.position.set(spot.x, 0, spot.z);
                group.userData = { id: spot.id, name: spot.name };
                
                // æ ‡ç­¾
                const div = document.createElement('div');
                div.className = spot.type === 'gate' ? 'label entrance-label' : 'label';
                div.innerHTML = `<b>${spot.name}</b>`;
                const label = new CSS2DObject(div);
                label.position.set(0, 12, 0);
                group.add(label);
                
                labelObjects[spot.id] = div;
                spotMeshes.push(group);
                scene.add(group);
            });
        }

        function renderSpotList() {
            const container = document.getElementById('spots-container');
            container.innerHTML = '';
            spots.forEach(spot => {
                const div = document.createElement('div');
                div.className = 'spot-item';
                div.id = `item-${spot.id}`;
                div.onclick = () => toggleSelection(spot.id, div);
                
                let tags = '';
                if(spot.type === 'gate') tags += '<span class="tag">å‡ºå…¥å£</span>';
                if(spot.type === 'indoor') tags += '<span class="tag">å®¤å†…</span>';
                if(spot.sensitive) tags += '<span class="tag red">éœ€é¢„çº¦</span>';
                else tags += '<span class="tag green">å¼€æ”¾</span>';

                div.innerHTML = `
                    <input type="checkbox" class="spot-check" value="${spot.id}" style="pointer-events:none;">
                    <div class="spot-info">
                        <div class="spot-name">${spot.name}</div>
                        <div class="spot-tags">${tags}</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- UI äº¤äº’é€»è¾‘ ---
        
        // 1. æ‰‹é£ç´æŠ˜å 
        window.toggleAccordion = function(header) {
            const item = header.parentElement;
            // å…³é—­å…¶ä»–
            document.querySelectorAll('.accordion-item').forEach(i => {
                if(i !== item) i.classList.remove('active');
            });
            item.classList.toggle('active');
        };

        // 2. ä¾§è¾¹æ å¼€å…³
        window.togglePanel = function() {
            document.getElementById('ui-panel').classList.toggle('collapsed');
            const btn = document.getElementById('ui-toggle-btn');
            btn.innerText = btn.innerText === 'â—€' ? 'â–¶' : 'â—€';
        };

        // 3. æ™¯ç‚¹é€‰æ‹©
        window.toggleSelection = function(id, el) {
            const checkbox = el.querySelector('input');
            checkbox.checked = !checkbox.checked;
            if(checkbox.checked) el.style.background = '#f0f9ff';
            else el.style.background = 'white';
        };

        window.clearSelection = function() {
            document.querySelectorAll('.spot-check').forEach(c => {
                c.checked = false;
                c.parentElement.style.background = 'white';
            });
            if(routeLine) scene.remove(routeLine);
        };

        // 4. æ¨¡æ‹Ÿå®¢æµæ¿€å¢
        window.toggleSurge = function() {
            isSurgeMode = !isSurgeMode;
            const btn = document.getElementById('btn-surge');
            const controls = document.getElementById('surge-controls');
            const sign = document.getElementById('digital-signage');
            
            if(isSurgeMode) {
                btn.innerText = "ğŸ”¥ åœæ­¢æ¨¡æ‹Ÿ";
                btn.classList.add('active');
                controls.style.display = 'block';
                sign.classList.remove('hidden');
                document.getElementById('signage-text').innerText = "âš ï¸ ç´§æ€¥é€šçŸ¥ï¼šæ¸©å®¤ç¾¤æ™¯åŒºå®¢æµè¿‡è½½ï¼Œè¯·æ¸¸å®¢é…åˆåˆ†æµã€‚";
                
                // æ ‡è®°æ¸©å®¤æ‹¥å µ
                const greenhouse = spots.find(s => s.id === 'conservatory');
                if(greenhouse) greenhouse.isCongested = true;
                updateLabels();
                
                // UI åˆ—è¡¨é«˜äº®
                const item = document.getElementById('item-conservatory');
                if(item) item.classList.add('congested');
            } else {
                btn.innerText = "ğŸ”¥ æ¨¡æ‹ŸèŠ‚å‡æ—¥å®¢æµæ¿€å¢";
                btn.classList.remove('active');
                controls.style.display = 'none';
                sign.classList.add('hidden');
                
                spots.forEach(s => s.isCongested = false);
                updateLabels();
                document.querySelectorAll('.spot-item').forEach(i => i.classList.remove('congested'));
            }
        };

        window.updateDiversion = function(val) {
            document.getElementById('diversion-val').innerText = val + '%';
            document.getElementById('est-time').innerText = Math.max(10, 60 - parseInt(val/2));
        };

        function updateLabels() {
            spots.forEach(s => {
                const div = labelObjects[s.id];
                if(s.isCongested) {
                    div.className = 'label congested-label';
                    div.innerHTML = `<b>${s.name}</b><br>ğŸ”¥ æ‹¥å µ`;
                } else {
                    div.className = s.type === 'gate' ? 'label entrance-label' : 'label';
                    div.innerHTML = `<b>${s.name}</b>`;
                }
            });
        }

        // 5. è·¯å¾„è§„åˆ’
        window.planRoute = function() {
            const checked = Array.from(document.querySelectorAll('.spot-check:checked')).map(c => c.value);
            if(checked.length < 1) { alert("è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ä¸ªæ™¯ç‚¹"); return; }

            // æ£€æŸ¥æ˜¯å¦åŒ…å«æ‹¥å µç‚¹
            if(isSurgeMode && checked.includes('conservatory')) {
                document.getElementById('decision-modal').style.display = 'block';
            } else {
                drawRoute(checked, false);
            }
        };

        window.confirmRoute = function(force) {
            document.getElementById('decision-modal').style.display = 'none';
            const checked = Array.from(document.querySelectorAll('.spot-check:checked')).map(c => c.value);
            
            if(!force) {
                // æ›¿æ¢æ¸©å®¤ä¸ºç§‘æ™®ä¸­å¿ƒ
                const idx = checked.indexOf('conservatory');
                if(idx !== -1) checked[idx] = 'museum';
                alert("å·²ä¸ºæ‚¨è‡ªåŠ¨è§„åˆ’å‰å¾€ [ç§‘æ™®ä¿¡æ¯ä¸­å¿ƒ] çš„ç•…é€šè·¯çº¿");
            }
            drawRoute(checked, force);
        };

        function drawRoute(ids, isRed) {
            if(routeLine) scene.remove(routeLine);
            
            // ç®€å•ç®—æ³•ï¼šä»æ­£é—¨å¼€å§‹ï¼ŒæŒ‰é¡ºåºè¿æ¥
            const points = [new THREE.Vector3(-20, 1, 120)]; // æ­£é—¨
            ids.forEach(id => {
                const s = spots.find(sp => sp.id === id);
                if(s) points.push(new THREE.Vector3(s.x, 1, s.z));
            });

            const curve = new THREE.CatmullRomCurve3(points);
            const tube = new THREE.TubeGeometry(curve, 64, 1, 8, false);
            const mat = new THREE.MeshBasicMaterial({ color: isRed ? 0xe74c3c : 0x27ae60 });
            routeLine = new THREE.Mesh(tube, mat);
            scene.add(routeLine);
        }

        // 6. åœ°å›¾æ ¡å‡†æ¨¡å¼
        let isCalibrating = false;
        window.toggleCalibration = function() {
            isCalibrating = !isCalibrating;
            const btn = document.getElementById('btn-calibrate');
            
            if(isCalibrating) {
                btn.innerText = "ğŸ’¾ ä¿å­˜ä½ç½®";
                btn.classList.add('active');
                if(!dragControls) {
                    dragControls = new DragControls(spotMeshes, camera, renderer.domElement);
                    dragControls.addEventListener('dragstart', () => controls.enabled = false);
                    dragControls.addEventListener('dragend', () => controls.enabled = true);
                    // é™åˆ¶Yè½´æ‹–åŠ¨
                    dragControls.addEventListener('drag', (e) => e.object.position.y = e.object.userData.id.includes('gate') ? 3 : 5);
                }
                dragControls.enabled = true;
            } else {
                btn.innerText = "ğŸ“ å¼€å¯ç‚¹ä½æ‹–æ‹½æ ¡å‡†";
                btn.classList.remove('active');
                if(dragControls) dragControls.enabled = false;
                alert("ä½ç½®å·²ä¿å­˜ (ä»…å½“å‰ä¼šè¯æœ‰æ•ˆ)");
            }
        };

        // --- DeepSeek AI æ¨¡æ‹Ÿé€»è¾‘ ---
        window.toggleChat = function() {
            const win = document.getElementById('ai-chat-window');
            win.style.display = win.style.display === 'flex' ? 'none' : 'flex';
        };

        window.handleEnter = function(e) {
            if(e.key === 'Enter') sendMessage();
        };

        window.sendMessage = async function() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;

            // 1. ç”¨æˆ·æ¶ˆæ¯ä¸Šå±
            addMsg(text, 'user');
            input.value = '';

            // 2. æ¨¡æ‹Ÿ AI æ€è€ƒ (Loading)
            const loadingId = addMsg("æ­£åœ¨æ€è€ƒ...", 'ai');

            // 3. æ¨¡æ‹Ÿ DeepSeek å›å¤ (å®é™…é¡¹ç›®ä¸­è¿™é‡Œæ›¿æ¢ä¸º fetch è°ƒç”¨ API)
            // è¿™é‡Œä½¿ç”¨æœ¬åœ°è§„åˆ™åº“æ¨¡æ‹Ÿæ™ºèƒ½å›å¤
            setTimeout(() => {
                const response = mockDeepSeekResponse(text);
                document.getElementById(loadingId).innerText = response;
            }, 800);
        };

        function addMsg(text, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = text;
            div.id = 'msg-' + Date.now();
            const body = document.getElementById('chat-body');
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
            return div.id;
        }

        // ğŸ¤– æœ¬åœ° AI é€»è¾‘ (æ¨¡æ‹Ÿ DeepSeek)
        function mockDeepSeekResponse(query) {
            const q = query.toLowerCase();
            if(q.includes("æ¸©å®¤") || q.includes("conservatory")) 
                return "æ¸©å®¤ç¾¤æ™¯åŒºä½äºå›­åŒºä¸œéƒ¨ï¼ŒåŒ…å«çƒ­å¸¦é›¨æ—å®¤ã€æ²™æ¼ æ¤ç‰©å®¤ç­‰ã€‚ç›®å‰å¦‚æœå¼€å¯äº†æ‹¥å µæ¨¡æ‹Ÿï¼Œå»ºè®®æ‚¨é”™å³°å‰å¾€ã€‚";
            if(q.includes("é—¨ç¥¨") || q.includes("é’±")) 
                return "åå—å›½å®¶æ¤ç‰©å›­å¤§é—¨ç¥¨ä¸º20å…ƒï¼Œæ¸©å®¤å¥—ç¥¨ä¸º50å…ƒã€‚å­¦ç”Ÿå’Œè€äººæœ‰åŠä»·ä¼˜æƒ å“¦ã€‚";
            if(q.includes("å•æ‰€") || q.includes("æ´—æ‰‹é—´")) 
                return "ä¸»è¦æ´—æ‰‹é—´ä½äºæ­£é—¨å…¥å£å·¦ä¾§ã€æ¸©å®¤ç¾¤æ™¯åŒºæ—ä»¥åŠä¸­å¿ƒå¤§è‰åªåŒ—ä¾§ã€‚";
            if(q.includes("è·¯çº¿") || q.includes("æ¨è")) 
                return "å¦‚æœæ‚¨æ—¶é—´å……è£•ï¼Œæ¨èè·¯çº¿ï¼šæ­£é—¨ -> é¾™æ´çªæ— -> ä¸­å¿ƒå¤§è‰åª -> æ¸©å®¤ç¾¤æ™¯åŒº -> é—å€ã€‚å…¨ç¨‹çº¦éœ€3å°æ—¶ã€‚";
            if(q.includes("ä½ å¥½") || q.includes("hi")) 
                return "æ‚¨å¥½ï¼æˆ‘æ˜¯ DeepSeek é©±åŠ¨çš„æ¤ç‰©å›­æ™ºèƒ½åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ";
            
            return "è¿™ä¸ªé—®é¢˜å¾ˆæœ‰è¶£ï¼Œä½†æˆ‘ç›®å‰ä¸»è¦ä¸“æ³¨äºæ¤ç‰©å›­çš„å¯¼è§ˆæœåŠ¡ã€‚æ‚¨å¯ä»¥é—®æˆ‘å…³äºæ™¯ç‚¹ä½ç½®ã€é—¨ç¥¨æˆ–è·¯çº¿çš„é—®é¢˜ã€‚";
        }

        // çª—å£è°ƒæ•´
        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            labelRenderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            labelRenderer.render(scene, camera);
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>